name: TestFlight Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      release_notes:
        description: 'TestFlight release notes'
        required: false
        default: 'Bug fixes and improvements'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  SCHEME: "Electro Cycles"
  BUNDLE_ID: "com.electrocycles.app"

jobs:
  testflight:
    name: Build & Upload to TestFlight
    runs-on: macos-14

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Show Xcode version
      run: xcodebuild -version

    # ──────────────────────────────────────────────
    # Code Signing Setup
    # ──────────────────────────────────────────────

    - name: Install Apple certificate and provisioning profile
      env:
        CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
        CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        PROVISIONING_PROFILE_BASE64: ${{ secrets.PROVISIONING_PROFILE_BASE64 }}
        KEYCHAIN_PASSWORD: ${{ github.run_id }}
      run: |
        # Create variables
        CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
        PROVISIONING_PROFILE_PATH=$RUNNER_TEMP/profile.mobileprovision
        KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

        # Decode from base64
        echo -n "$CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH
        echo -n "$PROVISIONING_PROFILE_BASE64" | base64 --decode -o $PROVISIONING_PROFILE_PATH

        # Create temporary keychain
        security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

        # Import certificate to keychain
        security import $CERTIFICATE_PATH -P "$CERTIFICATE_PASSWORD" \
          -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
        security set-key-partition-list -S apple-tool:,apple: \
          -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        security list-keychain -d user -s $KEYCHAIN_PATH

        # Install provisioning profile
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        cp $PROVISIONING_PROFILE_PATH ~/Library/MobileDevice/Provisioning\ Profiles/

    # ──────────────────────────────────────────────
    # Increment Build Number
    # ──────────────────────────────────────────────

    - name: Increment build number
      run: |
        BUILD_NUMBER=${{ github.run_number }}

        # Update build number in Info.plist
        /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD_NUMBER" "Electro Cycles/Info.plist"

        echo "Build number set to: $BUILD_NUMBER"

    # ──────────────────────────────────────────────
    # Archive
    # ──────────────────────────────────────────────

    - name: Archive app
      run: |
        xcodebuild archive \
          -project "Electro Cycles.xcodeproj" \
          -scheme "$SCHEME" \
          -destination "generic/platform=iOS" \
          -configuration Release \
          -archivePath $RUNNER_TEMP/ElectroCycles.xcarchive \
          CODE_SIGN_STYLE=Manual \
          PROVISIONING_PROFILE_SPECIFIER="${{ secrets.PROVISIONING_PROFILE_NAME }}" \
          CODE_SIGN_IDENTITY="${{ secrets.CODE_SIGN_IDENTITY }}"

    # ──────────────────────────────────────────────
    # Export IPA
    # ──────────────────────────────────────────────

    - name: Create export options plist
      run: |
        cat > $RUNNER_TEMP/ExportOptions.plist << 'PLIST'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
          "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
          <key>method</key>
          <string>app-store-connect</string>
          <key>destination</key>
          <string>upload</string>
          <key>signingStyle</key>
          <string>manual</string>
          <key>uploadSymbols</key>
          <true/>
          <key>provisioningProfiles</key>
          <dict>
            <key>com.electrocycles.app</key>
            <string>${{ secrets.PROVISIONING_PROFILE_NAME }}</string>
          </dict>
        </dict>
        </plist>
        PLIST

    - name: Export IPA
      run: |
        xcodebuild -exportArchive \
          -archivePath $RUNNER_TEMP/ElectroCycles.xcarchive \
          -exportOptionsPlist $RUNNER_TEMP/ExportOptions.plist \
          -exportPath $RUNNER_TEMP/export

    # ──────────────────────────────────────────────
    # Upload to TestFlight
    # ──────────────────────────────────────────────

    - name: Upload to TestFlight
      env:
        APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.ASC_KEY_ID }}
        APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
        APP_STORE_CONNECT_API_KEY: ${{ secrets.ASC_API_KEY }}
      run: |
        # Write API key to file
        mkdir -p ~/.private_keys
        echo -n "$APP_STORE_CONNECT_API_KEY" > ~/.private_keys/AuthKey_${APP_STORE_CONNECT_API_KEY_ID}.p8

        # Find the exported IPA
        IPA_PATH=$(find $RUNNER_TEMP/export -name "*.ipa" | head -1)

        if [ -z "$IPA_PATH" ]; then
          echo "Error: No IPA file found in export directory"
          exit 1
        fi

        echo "Uploading $IPA_PATH to TestFlight..."

        xcrun altool --upload-app \
          --type ios \
          --file "$IPA_PATH" \
          --apiKey "$APP_STORE_CONNECT_API_KEY_ID" \
          --apiIssuer "$APP_STORE_CONNECT_API_ISSUER_ID"

    # ──────────────────────────────────────────────
    # Upload Archive Artifact (backup)
    # ──────────────────────────────────────────────

    - name: Upload IPA artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: electrocycles-ipa
        path: ${{ runner.temp }}/export/*.ipa
        if-no-files-found: ignore
        retention-days: 30

    # ──────────────────────────────────────────────
    # Cleanup
    # ──────────────────────────────────────────────

    - name: Clean up keychain and provisioning profile
      if: always()
      run: |
        security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true
        rm -f $RUNNER_TEMP/certificate.p12 || true
        rm -f $RUNNER_TEMP/profile.mobileprovision || true
        rm -rf ~/.private_keys || true
